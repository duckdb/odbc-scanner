# name: test/sql/mssql/transactions.test
# description: test for MSSQL transactions
# group: [mssql_transactions]

require odbc_scanner

statement ok
SET VARIABLE conn1 = odbc_connect('ODBCSCANNER_DEBUG_CONN_STRING_ENV_VAR=ODBC_CONN_STRING')

statement ok
SET VARIABLE conn2 = odbc_connect('ODBCSCANNER_DEBUG_CONN_STRING_ENV_VAR=ODBC_CONN_STRING')

statement ok
SELECT * FROM odbc_query(getvariable('conn1'), 'DROP TABLE IF EXISTS duckdb_transactions_test')

statement ok
SELECT * FROM odbc_query(getvariable('conn1'), 'CREATE TABLE duckdb_transactions_test(col1 INT)')

# check auto-commit enabled by default

statement ok
SELECT * FROM odbc_query(getvariable('conn1'), 'INSERT INTO duckdb_transactions_test VALUES(42)')

query I
SELECT * FROM odbc_query(getvariable('conn1'), 'SELECT * FROM duckdb_transactions_test ORDER BY col1')
----
42

query I
SELECT * FROM odbc_query(getvariable('conn2'), 'SELECT * FROM duckdb_transactions_test ORDER BY col1')
----
42

statement ok
SELECT odbc_rollback(getvariable('conn1'))

query I
SELECT * FROM odbc_query(getvariable('conn1'), 'SELECT * FROM duckdb_transactions_test ORDER BY col1')
----
42

query I
SELECT * FROM odbc_query(getvariable('conn2'), 'SELECT * FROM duckdb_transactions_test ORDER BY col1')
----
42

# check transactions enabled, cannot check isolation as second connection hangs
# in default MSSQL mode with disabled MVCC

statement ok
SELECT odbc_begin_transaction(getvariable('conn1'))

statement ok
SELECT * FROM odbc_query(getvariable('conn1'), 'INSERT INTO duckdb_transactions_test VALUES(43)')

query I
SELECT * FROM odbc_query(getvariable('conn1'), 'SELECT * FROM duckdb_transactions_test ORDER BY col1')
----
42
43

statement ok
SELECT odbc_rollback(getvariable('conn1'))

query I
SELECT * FROM odbc_query(getvariable('conn1'), 'SELECT * FROM duckdb_transactions_test ORDER BY col1')
----
42

query I
SELECT * FROM odbc_query(getvariable('conn2'), 'SELECT * FROM duckdb_transactions_test ORDER BY col1')
----
42

statement ok
SELECT * FROM odbc_query(getvariable('conn1'), 'INSERT INTO duckdb_transactions_test VALUES(44)')

query I
SELECT * FROM odbc_query(getvariable('conn1'), 'SELECT * FROM duckdb_transactions_test ORDER BY col1')
----
42
44

statement ok
SELECT odbc_commit(getvariable('conn1'))

statement ok
SELECT * FROM odbc_query(getvariable('conn2'), 'INSERT INTO duckdb_transactions_test VALUES(45)')

query I
SELECT * FROM odbc_query(getvariable('conn1'), 'SELECT * FROM duckdb_transactions_test ORDER BY col1')
----
42
44
45

query I
SELECT * FROM odbc_query(getvariable('conn2'), 'SELECT * FROM duckdb_transactions_test ORDER BY col1')
----
42
44
45

statement ok
SELECT odbc_rollback(getvariable('conn2'))


query I
SELECT * FROM odbc_query(getvariable('conn1'), 'SELECT * FROM duckdb_transactions_test ORDER BY col1')
----
42
44
45

query I
SELECT * FROM odbc_query(getvariable('conn2'), 'SELECT * FROM duckdb_transactions_test ORDER BY col1')
----
42
44
45

# cleanup

statement ok
SELECT * FROM odbc_query(getvariable('conn1'), 'DROP TABLE duckdb_transactions_test')

statement ok
SELECT odbc_close(getvariable('conn1'))

statement ok
SELECT odbc_close(getvariable('conn2'))
