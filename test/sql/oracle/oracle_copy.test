# name: test/sql/oracle/oracle_copy.test
# description: test odbc_copy() function with Oracle
# group: [oracle_copy]

require odbc_scanner

statement ok
SET VARIABLE conn = odbc_connect('ODBCSCANNER_DEBUG_CONN_STRING_ENV_VAR=ODBC_CONN_STRING')

statement ok
SELECT * FROM odbc_query(getvariable('conn'), 'DROP TABLE DUCKDB_TEST_COPY', ignore_exec_failure=TRUE)

# no destination

statement error
SELECT completed, rows_processed FROM odbc_copy(getvariable('conn'),
  dest_table='DUCKDB_TEST_COPY',
  source_queries=[
    'CREATE TABLE copy_test_basic(col1 SMALLINT, col2 INTEGER)',
    'INSERT INTO copy_test_basic VALUES (41, 42), (43, 44)',
    'SELECT * FROM copy_test_basic'
    ])
----
ORA-00942: table or view does not exist

# basic

query II
SELECT completed, rows_processed FROM odbc_copy(getvariable('conn'),
  dest_table='DUCKDB_TEST_COPY',
  create_table=TRUE,
  source_queries=[
    'CREATE TABLE copy_test_basic(col1 SMALLINT, col2 INTEGER)',
    'INSERT INTO copy_test_basic VALUES (41, 42), (43, 44)',
    'SELECT * FROM copy_test_basic'
    ])
----
1	2

query II
SELECT * FROM odbc_query(getvariable('conn'), 'SELECT * FROM DUCKDB_TEST_COPY')
----
41	42
43	44

statement ok
SELECT * FROM odbc_query(getvariable('conn'), 'DROP TABLE DUCKDB_TEST_COPY')

# boolean

query II
SELECT completed, rows_processed FROM odbc_copy(getvariable('conn'),
  dest_table='DUCKDB_TEST_COPY',
  create_table=TRUE,
  source_queries=[
    'CREATE TABLE copy_test_boolean(col1 BOOLEAN)',
    'INSERT INTO copy_test_boolean VALUES (TRUE), (NULL), (FALSE)',
    'SELECT * FROM copy_test_boolean'
    ])
----
1	3

query I
SELECT column_type from (
  DESCRIBE SELECT * FROM odbc_query(getvariable('conn'),
    'SELECT * FROM DUCKDB_TEST_COPY')
)
----
DECIMAL(1,0)

query I
SELECT * FROM odbc_query(getvariable('conn'), 'SELECT * FROM DUCKDB_TEST_COPY')
----
1
NULL
0

statement ok
SELECT * FROM odbc_query(getvariable('conn'), 'DROP TABLE DUCKDB_TEST_COPY')

# integrals

query II
SELECT completed, rows_processed FROM odbc_copy(getvariable('conn'),
  dest_table='DUCKDB_TEST_COPY',
  create_table=TRUE,
  source_queries=[
    'CREATE TABLE copy_test_integrals(
      col1 TINYINT,
      col2 UTINYINT,
      col3 SMALLINT,
      col4 USMALLINT,
      col5 INTEGER,
      col6 UINTEGER,
      col7 BIGINT,
      col8 UBIGINT
    )',
    'INSERT INTO copy_test_integrals VALUES (1,2,3,4,5,6,7,8)',
    'SELECT * FROM copy_test_integrals'
    ])
----
1	1

query I
SELECT column_type from (
  DESCRIBE SELECT * FROM odbc_query(getvariable('conn'),
    'SELECT * FROM DUCKDB_TEST_COPY')
)
----
DECIMAL(3,0)
DECIMAL(3,0)
DECIMAL(5,0)
DECIMAL(5,0)
DECIMAL(10,0)
DECIMAL(10,0)
DECIMAL(19,0)
DECIMAL(19,0)

query IIIIIIII
SELECT * FROM odbc_query(getvariable('conn'), 'SELECT * FROM DUCKDB_TEST_COPY')
----
1	2	3	4	5	6	7	8

statement ok
SELECT * FROM odbc_query(getvariable('conn'), 'DROP TABLE DUCKDB_TEST_COPY')

# floats

query II
SELECT completed, rows_processed FROM odbc_copy(getvariable('conn'),
  dest_table='DUCKDB_TEST_COPY',
  create_table=TRUE,
  source_queries=[
    'CREATE TABLE copy_test_floats(
      col1 FLOAT,
      col2 DOUBLE
    )',
    'INSERT INTO copy_test_floats VALUES (1.0, 2.0)',
    'SELECT * FROM copy_test_floats'
    ])
----
1	1

query I
SELECT column_type from (
  DESCRIBE SELECT * FROM odbc_query(getvariable('conn'),
    'SELECT * FROM DUCKDB_TEST_COPY')
)
----
FLOAT
DOUBLE

query II
SELECT * FROM odbc_query(getvariable('conn'), 'SELECT * FROM DUCKDB_TEST_COPY')
----
1.0	2.0

statement ok
SELECT * FROM odbc_query(getvariable('conn'), 'DROP TABLE DUCKDB_TEST_COPY')

# decimal

query II
SELECT completed, rows_processed FROM odbc_copy(getvariable('conn'),
  dest_table='DUCKDB_TEST_COPY',
  create_table=TRUE,
  source_queries=[
    'CREATE TABLE copy_test_decimal(
      col1 DECIMAL(7, 5),
      col2 DECIMAL(38, 10)
    )',
    'INSERT INTO copy_test_decimal VALUES (1.0, 2.0)',
    'SELECT * FROM copy_test_decimal'
    ])
----
1	1

query I
SELECT column_type from (
  DESCRIBE SELECT * FROM odbc_query(getvariable('conn'),
    'SELECT * FROM DUCKDB_TEST_COPY')
)
----
DECIMAL(7,5)
DECIMAL(38,10)

query II
SELECT * FROM odbc_query(getvariable('conn'), 'SELECT * FROM DUCKDB_TEST_COPY')
----
1.0	2.0

statement ok
SELECT * FROM odbc_query(getvariable('conn'), 'DROP TABLE DUCKDB_TEST_COPY')

# temporal

query II
SELECT completed, rows_processed FROM odbc_copy(getvariable('conn'),
  dest_table='DUCKDB_TEST_COPY',
  create_table=TRUE,
  source_queries=[
    'CREATE TABLE copy_test_temporal(
      col1 DATE,
      col2 TIMESTAMP,
      col5 TIMESTAMP_NS,
    )',
    'INSERT INTO copy_test_temporal VALUES (
      ''2020-12-31'',
      ''2020-12-31 01:02:03.456789'',
      ''2020-12-31 01:02:03.456789012'',
    )',
    'SELECT * FROM copy_test_temporal'
    ])
----
1	1

query I
SELECT column_type from (
  DESCRIBE SELECT * FROM odbc_query(getvariable('conn'),
    'SELECT * FROM DUCKDB_TEST_COPY')
)
----
DATE
TIMESTAMP
TIMESTAMP

query III
SELECT * FROM odbc_query(getvariable('conn'), 'SELECT * FROM DUCKDB_TEST_COPY')
----
2020-12-31	2020-12-31 01:02:03.456789	2020-12-31 01:02:03.456789

statement ok
SELECT * FROM odbc_query(getvariable('conn'), 'DROP TABLE DUCKDB_TEST_COPY')

# varchar

query II
SELECT completed, rows_processed FROM odbc_copy(getvariable('conn'),
  dest_table='DUCKDB_TEST_COPY',
  create_table=TRUE,
  source_queries=[
    'CREATE TABLE copy_test_varchar(
      col1 VARCHAR,
    )',
    'INSERT INTO copy_test_varchar VALUES (
      ''ðŸŒŒ''
    )',
    'SELECT * FROM copy_test_varchar'
    ])
----
1	1

query I
SELECT column_type from (
  DESCRIBE SELECT * FROM odbc_query(getvariable('conn'),
    'SELECT * FROM DUCKDB_TEST_COPY')
)
----
VARCHAR

query I
SELECT * FROM odbc_query(getvariable('conn'), 'SELECT * FROM DUCKDB_TEST_COPY')
----
ðŸŒŒ

statement ok
SELECT * FROM odbc_query(getvariable('conn'), 'DROP TABLE DUCKDB_TEST_COPY')

# blob

query II
SELECT completed, rows_processed FROM odbc_copy(getvariable('conn'),
  dest_table='DUCKDB_TEST_COPY',
  create_table=TRUE,
  source_queries=[
    'CREATE TABLE copy_test_blob(
      col1 BLOB,
    )',
    'INSERT INTO copy_test_blob VALUES (
      ''foo\x00bar''
    )',
    'SELECT * FROM copy_test_blob'
    ])
----
1	1

query I
SELECT column_type from (
  DESCRIBE SELECT * FROM odbc_query(getvariable('conn'),
    'SELECT * FROM DUCKDB_TEST_COPY')
)
----
BLOB

query I
SELECT * FROM odbc_query(getvariable('conn'), 'SELECT * FROM DUCKDB_TEST_COPY')
----
foo\x00bar

statement ok
SELECT * FROM odbc_query(getvariable('conn'), 'DROP TABLE DUCKDB_TEST_COPY')

# custom

query II
SELECT completed, rows_processed FROM odbc_copy(getvariable('conn'),
  dest_table='DUCKDB_TEST_COPY',
  create_table=TRUE,
  source_queries=[
    'CREATE TABLE copy_test_custom(
      col1 VARCHAR,
    )',
    'INSERT INTO copy_test_custom VALUES (
      ''ðŸŒŒ''
    )',
    'SELECT * FROM copy_test_custom'
    ],
  column_types=MAP {'DUCKDB_TYPE_VARCHAR' : 'VARCHAR2(10)'}
  )
----
1	1

query I
SELECT column_type from (
  DESCRIBE SELECT * FROM odbc_query(getvariable('conn'),
    'SELECT * FROM DUCKDB_TEST_COPY')
)
----
VARCHAR

query I
SELECT * FROM odbc_query(getvariable('conn'), 'SELECT * FROM DUCKDB_TEST_COPY')
----
?

statement ok
SELECT * FROM odbc_query(getvariable('conn'), 'DROP TABLE DUCKDB_TEST_COPY')

# explicit dest query

statement ok
SELECT * FROM odbc_query(getvariable('conn'),
  'CREATE TABLE DUCKDB_TEST_COPY (
    col1 NUMBER(10,0),
    col2 VARCHAR2(10),
    col3 NUMBER(10,0),
    col4 NVARCHAR2(10)
  )')

query II
SELECT completed, rows_processed FROM odbc_copy(getvariable('conn'),
  create_table=FALSE,
  batch_size=2,
  source_queries=[
    'CREATE TABLE copy_test_dest_query(
      col1 INTEGER,
      col2 VARCHAR
    )',
    'INSERT INTO copy_test_dest_query VALUES 
      (42, ''foo''),
      (43, ''ðŸŒŒ'')
    ',
    'SELECT * FROM copy_test_dest_query'
    ],
  dest_query='INSERT INTO DUCKDB_TEST_COPY VALUES(?,?,?,?)')
----
1	2

query IIII
SELECT * FROM odbc_query(getvariable('conn'), 'SELECT * FROM DUCKDB_TEST_COPY')
----
42	foo	43	ðŸŒŒ

statement ok
SELECT * FROM odbc_query(getvariable('conn'), 'DROP TABLE DUCKDB_TEST_COPY')

# dest query with a tail

statement ok
SELECT * FROM odbc_query(getvariable('conn'),
  'CREATE TABLE DUCKDB_TEST_COPY (
    col1_1 NUMBER(10,0),
    col1_2 NVARCHAR2(10),
    col2_1 NUMBER(10,0),
    col2_2 NVARCHAR2(10),
    col3_1 NUMBER(10,0),
    col3_2 NVARCHAR2(10),
    col4_1 NUMBER(10,0),
    col4_2 NVARCHAR2(10)
  )')


query II
SELECT completed, rows_processed FROM odbc_copy(getvariable('conn'),
  batch_size=4,
  source_queries=[
    'CREATE TABLE copy_test_dest_query(
      col1 INTEGER,
      col2 VARCHAR
    )',
    'INSERT INTO copy_test_dest_query VALUES 
      (1, ''s1''),
      (2, ''s2''),
      (3, ''s3''),
      (4, ''s4''),
      (5, ''s5''),
      (6, ''s6''),
      (7, ''s7''),
      (8, ''s8''),
      (9, ''s9''),
      (10, ''s10''),
      (11, ''s11'')
    ',
    'SELECT * FROM copy_test_dest_query'
    ],
  dest_query='INSERT INTO DUCKDB_TEST_COPY VALUES(?,?,?,?,?,?,?,?)',
  dest_query_single='INSERT INTO DUCKDB_TEST_COPY VALUES(NULL,NULL,?,?,NULL,NULL,NULL,NULL)'
  )
----
1	11

query IIIIIIII
SELECT * FROM odbc_query(getvariable('conn'), 'SELECT * FROM DUCKDB_TEST_COPY')
----
1	s1	2	s2	3	s3	4	s4
5	s5	6	s6	7	s7	8	s8
NULL	NULL	9	s9	NULL	NULL	NULL	NULL
NULL	NULL	10	s10	NULL	NULL	NULL	NULL
NULL	NULL	11	s11	NULL	NULL	NULL	NULL

statement ok
SELECT * FROM odbc_query(getvariable('conn'), 'DROP TABLE DUCKDB_TEST_COPY')

# error when copying, make sure the hang on driver unload is not happening
# note: use the incorrect error message to trigger the hanging

statement error
SELECT completed, rows_processed FROM odbc_copy(getvariable('conn'),
  dest_table='DUCKDB_TEST_COPY',
  create_table=TRUE,
  source_query='SELECT * FROM fail'
)
----
Table with name fail does not exist

# source limit

statement error
SELECT completed, rows_processed FROM odbc_copy(getvariable('conn'),
  dest_table='DUCKDB_TEST_COPY',
  create_table=TRUE,
  source_limit=1024,
  source_query='SELECT 42')
----
invalid source limit specified

query II
SELECT completed, rows_processed FROM odbc_copy(getvariable('conn'),
  dest_table='DUCKDB_TEST_COPY',
  create_table=TRUE,
  source_limit=4096,
  source_queries=[
    'CREATE TABLE copy_test_limit AS SELECT unnest(repeat([1,2,3,4,5,6,7,8,9], 2048)) col1',
    'SELECT * FROM copy_test_limit'
    ])
----
0	2048
0	4096
0	6144
0	8192
0	10240
0	12288
0	14336
0	16384
1	18432

query I
SELECT * FROM odbc_query(getvariable('conn'), 'SELECT count(*) FROM DUCKDB_TEST_COPY')
----
18432.0

query I
SELECT * FROM odbc_query(getvariable('conn'), 'SELECT sum("col1") FROM DUCKDB_TEST_COPY')
----
92160.0

statement ok
SELECT * FROM odbc_query(getvariable('conn'), 'DROP TABLE DUCKDB_TEST_COPY')

statement ok
SELECT odbc_close(getvariable('conn'))
